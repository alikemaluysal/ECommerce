name: Deploy .NET to FTP

on:
  push:
    branches:
      - dev
    paths:
      - "backend/**"
      - ".github/workflows/deploy-dotnet-ftp.yml"
  workflow_dispatch:

concurrency:
  group: deploy-webapi-dev
  cancel-in-progress: true

env:
  DOTNET_VERSION: "8.0.x"
  PUBLISH_PATH: "./publish"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        working-directory: backend
        run: dotnet restore

      - name: Build
        working-directory: backend
        run: dotnet build --configuration Release --no-restore

      - name: Publish
        working-directory: backend
        run: dotnet publish --configuration Release --output ../publish --no-build

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Create app_offline.htm
        run: |
          cat > app_offline.htm << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8" />
            <title>Maintenance</title>
          </head>
          <body style="font-family: Arial, sans-serif; text-align:center; margin-top:80px;">
            <h1>Maintenance in progress</h1>
          </body>
          </html>
          EOF

      - name: Enable maintenance mode (FTPS)
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -e "
            set cmd:fail-exit true;
            set ftp:ssl-force true;
            set ftp:ssl-protect-data true;
            set ssl:verify-certificate no;
            set ftp:passive-mode true;
            set net:timeout 60;
            set net:max-retries 50;
            set net:reconnect-interval-base 5;
            set net:reconnect-interval-max 30;

            open -u $FTP_USERNAME,$FTP_PASSWORD -p $FTP_PORT $FTP_SERVER;
            cd $FTP_REMOTE_DIR;
            put app_offline.htm;
            bye
          "

      - name: Deploy via FTPS (Only Changed Files)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: ${{ secrets.FTP_PORT }}
          local-dir: ${{ env.PUBLISH_PATH }}/
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}/
          state-name: .ftp-deploy-sync-state.json
          dangerous-clean-slate: false
          log-level: standard
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            app_offline.htm
            appsettings.Development.json
            **/*.pdb

      - name: Disable maintenance mode (FTPS)
        if: always()
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -e "
            set cmd:fail-exit true;
            set ftp:ssl-force true;
            set ftp:ssl-protect-data true;
            set ssl:verify-certificate no;
            set ftp:passive-mode true;
            set net:timeout 60;
            set net:max-retries 50;
            set net:reconnect-interval-base 5;
            set net:reconnect-interval-max 30;

            open -u $FTP_USERNAME,$FTP_PASSWORD -p $FTP_PORT $FTP_SERVER;
            cd $FTP_REMOTE_DIR;
            rm -f app_offline.htm;
            bye
          "
