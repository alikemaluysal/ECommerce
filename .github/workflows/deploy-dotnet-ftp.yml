name: Release and Deploy to Web Hosting (Hybrid - Fast)

on:
  push:
    branches:
      - dev
    paths:
      - "backend/**"
      - ".github/workflows/deploy-dotnet-ftp.yml"
  workflow_dispatch:

concurrency:
  group: deploy-webapi-dev
  cancel-in-progress: true

env:
  DOTNET_VERSION: "8.0.x"
  PROJECT_PATH: "backend/src/eCommerce/WebAPI/WebAPI.csproj" 
  PUBLISH_PATH: "./publish"
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Clean publish folder
        run: rm -rf "${{ env.PUBLISH_PATH }}"

      - name: Restore
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      - name: Build
        run: dotnet build "${{ env.PROJECT_PATH }}" --configuration Release --no-restore

      - name: Publish
        run: dotnet publish "${{ env.PROJECT_PATH }}" --configuration Release --output "${{ env.PUBLISH_PATH }}" --no-build

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Create app_offline.htm
        run: |
          cat > app_offline.htm << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8" />
            <title>Maintenance</title>
          </head>
          <body style="font-family: Arial, sans-serif; text-align:center; margin-top:80px;">
            <h1>Maintenance in progress</h1>
          </body>
          </html>
          EOF

      - name: Put app_offline.htm (via lftp - FAST)
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -e "
            set cmd:fail-exit true;
            set ftp:ssl-force true;
            set ftp:ssl-protect-data true;
            set ssl:verify-certificate no;
            set ftp:passive-mode true;
            set net:timeout 60;
            set net:max-retries 50;
            set net:reconnect-interval-base 5;
            set net:reconnect-interval-max 30;
            open -u $FTP_USERNAME,$FTP_PASSWORD -p $FTP_PORT $FTP_SERVER;
            cd $FTP_REMOTE_DIR;
            put app_offline.htm;
            bye
          "

      - name: Deploy to Web Hosting via FTPS (Only Changed Files)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: ${{ secrets.FTP_PORT }}
          local-dir: ${{ env.PUBLISH_PATH }}/
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}
          state-name: .ftp-deploy-sync-state.json
          dangerous-clean-slate: false
          log-level: standard
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            app_offline.htm
            appsettings.Development.json
            **/*.pdb
            **/CodeCoverage/**
            **/InstrumentationEngine/**
            **/runtimes/**
            **/*.Tests.*
            **/testhost.dll
            **/xunit*.dll
            **/coverlet*.*
            **/Microsoft.TestPlatform*.dll
            **/Microsoft.VisualStudio.TestPlatform*.dll

      - name: Remove app_offline.htm (via lftp - FAST)
        if: always()
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -e "
            set cmd:fail-exit true;
            set ftp:ssl-force true;
            set ftp:ssl-protect-data true;
            set ssl:verify-certificate no;
            set ftp:passive-mode true;
            set net:timeout 60;
            set net:max-retries 50;
            set net:reconnect-interval-base 5;
            set net:reconnect-interval-max 30;
            open -u $FTP_USERNAME,$FTP_PASSWORD -p $FTP_PORT $FTP_SERVER;
            cd $FTP_REMOTE_DIR;
            rm -f app_offline.htm;
            bye
          "
